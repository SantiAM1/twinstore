
{% extends 'base.html' %}
{% load static %}
{% block head %}
<style>
    .users-facturacion-form {
        gap: 1rem;
    }
    .users-datos-personales {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        width: 100%;
    }
    .users-label {
        color: #2e2e2e;
        font-size: 1.2rem;
        border-bottom: 1px solid rgb(204, 204, 204);
        width: max-content;
    }
    .users-facturacion-type label {
        padding-top: 0.5rem;
    }
</style>
{% endblock head %}

{% block contenidomain %}
<main class="padding-1rem">
    <div class="users-facturacion-box">
        <div>
            <h2>Mi Perfil</h2>
        </div>
        <form action="{% url 'users:perfil' %}" method="post">
            {% csrf_token %}
            <div class="users-datos-personales">
                <span class="users-label">Datos personales:</span>
                {{datos_personales_form.nombre}}
                {{datos_personales_form.apellido}}
                {{datos_personales_form.email}}
            </div>
            <div class="users-facturacion-type">
                <span class="users-label">Datos de facturacion:</span>
                {{ facturacion_form.tipo_factura.label_tag }}
                {{ facturacion_form.tipo_factura }}
            </div>
            <div class="users-facturacion-form">
                {{ facturacion_form.razon_social }}
                {{ facturacion_form.dni_cuit }}
            </div>
            <div class="users-datos-personales" style="position: relative;">
                <span class="users-label">Direccion de envio:</span>
                {{ datos_envio_form.direccion_completa }}

                {{ datos_envio_form.calle }}
                {{ datos_envio_form.altura }}
                {{ datos_envio_form.ciudad }}
                {{ datos_envio_form.provincia }}
                {{ datos_envio_form.codigo_postal }}
            
                <ul id="suggestions" style="position:absolute;top: 80px;border: 1px solid black; background:white; display:none; z-index:1000; width: 100%; list-style:none; padding:0"></ul>
            </div>
            <div class="users-datos-personales">
                <span class="users-label">Preferencias:</span>
                {{ preferencias_form.as_p }}
            </div>
            <button type="submit" class="users-facturacion-button">Guardar</button>
        </form>
    </div>
</main>
<script>
const input = document.getElementById('autocomplete');
const suggestions = document.getElementById('suggestions');
const apiKey = 'pk.041921c12bb10332cc8c181d7804a4c2';

input.addEventListener('input', function () {
    const query = input.value.trim();
    if (query.length < 3) {
        suggestions.style.display = 'none';
        return;
    }
    fetch(`https://api.locationiq.com/v1/autocomplete?key=${apiKey}&q=${query}&limit=5&countrycodes=ar`)
        .then(response => response.json())
        .then(data => {
            suggestions.innerHTML = '';
            data.forEach(item => {
                const address = item.address;
                if (!address.road) return;

                const numero = address.house_number || '';
                const calle = address.road;
                const ciudad = address.city || address.town || address.village || address.state || '';
                const provincia = address.state || '';
                const codigoPostal = address.postcode || '';
                const latitud = item.lat;
                const longitud = item.lon;

                const displayString = [
                    `${calle} ${numero}`.trim(),
                    ciudad || provincia,
                    codigoPostal,
                    address.country || ''
                ].filter(Boolean).join(', ');

                const li = document.createElement('li');
                li.textContent = displayString;
                li.style.padding = '8px';
                li.style.cursor = 'pointer';

                // Usamos mousedown para evitar que el blur del input ocurra antes
                li.addEventListener('mousedown', (event) => {
                    event.preventDefault();
                    input.value = displayString;
                    document.getElementById('id_calle').value = calle;
                    document.getElementById('id_altura').value = numero;
                    document.getElementById('id_ciudad').value = ciudad;
                    document.getElementById('id_provincia').value = provincia;
                    document.getElementById('id_codigo_postal').value = codigoPostal;
                    document.getElementById('id_latitud').value = latitud;
                    document.getElementById('id_longitud').value = longitud;
                    suggestions.style.display = 'none';
                    suggestions.innerHTML = '';
                });

                suggestions.appendChild(li);
            });
            suggestions.style.display = data.length ? 'block' : 'none';
        })
        .catch(() => suggestions.style.display = 'none');
});

// Ocultar el listado si pierde el foco, con delay para permitir mousedown
input.addEventListener('blur', () => {
    setTimeout(() => {
        suggestions.innerHTML = '';
        suggestions.style.display = 'none';
    }, 200);
});

// También cerrarlo si se clickea en cualquier parte fuera
document.addEventListener('click', function (event) {
    if (!suggestions.contains(event.target) && event.target !== input) {
        suggestions.innerHTML = '';
        suggestions.style.display = 'none';
    }
});    
    // Lógica para mostrar/ocultar campos según el tipo de factura
    function actualizarCamposSegunFactura() {
        const tipoFactura = document.querySelector('#id_tipo_factura').value;
        const razonSocialGroup = document.getElementById('id_razon_social');
        const dniCuitPlace = document.getElementById('id_dni_cuit');
    
        if (tipoFactura === 'A' || tipoFactura === 'C') {
            razonSocialGroup.style.display = 'block';
            dniCuitPlace.placeholder = 'CUIT';
        } else {
            razonSocialGroup.style.display = 'none';
            document.querySelector('#id_razon_social').value = '';
            dniCuitPlace.placeholder = 'DNI';
        }
    }
    
    document.addEventListener('DOMContentLoaded', function () {
        actualizarCamposSegunFactura();
        const tipoFacturaField = document.querySelector('#id_tipo_factura');
        if (tipoFacturaField) {
            tipoFacturaField.addEventListener('change', actualizarCamposSegunFactura);
        }
    });
    </script>
    
    
{% endblock contenidomain %}

